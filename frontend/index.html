<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title >Azubi Voice Assistant</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="text-align:center;">Azubi Voice Assistant</h1>
      <p class="sub">Type text and click on speak to generate audio. For more natural speech, toggle ‚ÄúAdd pauses (SSML)‚Äù.</p>

      <label for="text">Text</label>
      <textarea id="text" placeholder="Hello from Azubi VA. Don‚Äôt worry, the stipends will come. Please let Flo rest a little."></textarea>
      <div class="meta">
        <div class="hint">Tip: keep your text short.</div>
        <div class="count" id="charCount">0 / 3000</div>
      </div>

      <div class="row">
        <div style="flex:2; min-width:240px;">
          <label for="voice">Voice</label>
          <select id="voice">
            <option>Joanna</option>
            <option>Matthew</option>
            <option>Amy</option>
            <option>Emma</option>
            <option>Brian</option>
            <option>Ivy</option>
            <option>Kendra</option>
            <option>Justin</option>
            <option>Kevin</option>
            <option>Kimberly</option>
          </select>
        </div>
        <div style="flex:1; min-width:160px;">
          <label for="format">Format</label>
          <select id="format">
            <option value="mp3" selected>mp3</option>
            <option value="ogg_vorbis">ogg_vorbis</option>
            <option value="pcm">pcm</option>
          </select>
        </div>
      </div>

      <div class="controls">
        <label class="switch"><input type="checkbox" id="ssml"> Add pauses (SSML)</label>
        <button id="speakBtn">üîä Speak</button>
        <span id="status" class="hint"></span>
      </div>

      <div id="error" class="error" style="display:none;"></div>

      <audio id="player" controls preload="none"></audio>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const API_BASE_URL = "https://3f1g9ndm9l.execute-api.us-east-1.amazonaws.com";
    const MAX_CHARS = 3000;

    const textEl = document.getElementById('text');
    const voiceEl = document.getElementById('voice');
    const formatEl = document.getElementById('format');
    const ssmlEl = document.getElementById('ssml');
    const speakBtn = document.getElementById('speakBtn');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const player = document.getElementById('player');
    const charCount = document.getElementById('charCount');

    // live char counter
    function updateCount() {
      const len = textEl.value.length;
      charCount.textContent = `${len} / ${MAX_CHARS}`;
      charCount.style.color = len > MAX_CHARS ? 'var(--danger)' : 'var(--muted)';
    }
    textEl.addEventListener('input', updateCount);
    updateCount();

    // naive SSML helper: inserts a 400ms break after periods
    function textToSsml(text) {
      const escaped = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      const withBreaks = escaped.replace(/\.\s+/g, ". <break time='400ms'/> ").trim();
      return `<speak>${withBreaks}</speak>`;
    }

    async function speak() {
      errorEl.style.display = 'none';
      errorEl.textContent = '';

      const text = textEl.value.trim();
      const voiceId = voiceEl.value;
      const format = formatEl.value;
      const useSsml = ssmlEl.checked;

      if (!text) {
        errorEl.textContent = "Please enter some text.";
        errorEl.style.display = 'block';
        return;
      }
      if (text.length > MAX_CHARS && !useSsml) {
        errorEl.textContent = `Text too long (${text.length}). Limit: ${MAX_CHARS}.`;
        errorEl.style.display = 'block';
        return;
      }

      const payload = useSsml
        ? { text: textToSsml(text), voiceId, format, useSsml: true }
        : { text, voiceId, format };

      speakBtn.disabled = true;
      const prevLabel = speakBtn.textContent;
      speakBtn.textContent = "Synthesizing‚Ä¶";
      statusEl.textContent = "Contacting API‚Ä¶";

      try {
        const res = await fetch(API_BASE_URL + "/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const maybeText = await res.text();
          let msg = `Request failed (${res.status})`;
          try { msg += `: ${JSON.parse(maybeText).error || maybeText}`; } catch { msg += `: ${maybeText}`; }
          throw new Error(msg);
        }

        const data = await res.json();
        if (!data.audioUrl) throw new Error("No audioUrl returned from API.");

        statusEl.textContent = "Loading audio‚Ä¶";
        player.src = data.audioUrl;
        try { await player.play(); } catch {}
        statusEl.textContent = "Done.";
      } catch (err) {
        errorEl.textContent = err.message || String(err);
        errorEl.style.display = 'block';
        statusEl.textContent = "";
      } finally {
        speakBtn.disabled = false;
        speakBtn.textContent = prevLabel;
      }
    }

    speakBtn.addEventListener('click', speak);
  </script>
</body>
</html>
